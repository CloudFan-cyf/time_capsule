name: Build & Release on PR merge to main

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write   # 创建 tag / release / 上传附件
  pull-requests: read

jobs:
  # 1) 计算下一个版本号 & 创建 Release（先创建一个 release，后续各平台 job 往里上传附件）
  prepare_release:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.tag }}
      version: ${{ steps.ver.outputs.version }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next semver tag (start from v0.1.0, bump patch)
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          git fetch --tags --force

          # 取最新 v* tag（按版本排序）
          latest="$(git tag -l 'v*' | sort -V | tail -n 1 || true)"

          if [ -z "${latest}" ]; then
            next="v0.1.0"
          else
            # 只处理形如 vMAJOR.MINOR.PATCH
            if [[ ! "${latest}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              echo "Latest tag '${latest}' is not semver vMAJOR.MINOR.PATCH. Please fix tags." >&2
              exit 1
            fi
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            patch=$((patch + 1))
            next="v${major}.${minor}.${patch}"
          fi

          echo "tag=${next}" >> "$GITHUB_OUTPUT"
          echo "version=${next#v}" >> "$GITHUB_OUTPUT"

      - name: Create Git tag
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.ver.outputs.tag }}"
          git tag "${tag}"
          git push origin "${tag}"

      - name: Create GitHub Release (notes from PR body)
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          body: |
            # Release Notes
            **PR:** #${{ github.event.pull_request.number }} — ${{ github.event.pull_request.title }}

            ${{ github.event.pull_request.body }}
          draft: false
          prerelease: false

  # 2) 各平台构建：产物打包成 zip，然后上传到刚才创建的 release
  build_and_upload:
    needs: prepare_release
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: android
            os: ubuntu-latest
          - name: web
            os: ubuntu-latest
          - name: linux
            os: ubuntu-latest
          - name: windows
            os: windows-latest
          - name: macos
            os: macos-latest
          - name: ios
            os: macos-latest

    runs-on: ${{ matrix.os }}
    if: ${{ github.event.pull_request.merged == true }}
    env:
      TAG: ${{ needs.prepare_release.outputs.tag }}
      VERSION: ${{ needs.prepare_release.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Flutter 安装 + cache（你也可以改成读取 FVM 版本）
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      # 可选：把版本号写进构建（一般 Flutter 用 pubspec.yaml 的 version）
      # 这里不强制修改 pubspec，避免污染工作区；如果你希望真正写入，可在这里加脚本替换 pubspec.yaml version。

      # ---------- Build ----------
      - name: Build Android (APK + AAB)
        if: ${{ matrix.name == 'android' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter build apk --release
          flutter build appbundle --release

          mkdir -p dist
          cp -f build/app/outputs/flutter-apk/app-release.apk "dist/app-${TAG}-android.apk"
          cp -f build/app/outputs/bundle/release/app-release.aab "dist/app-${TAG}-android.aab"

      - name: Build Web
        if: ${{ matrix.name == 'web' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter build web --release
          mkdir -p dist
          (cd build && zip -r "../dist/app-${TAG}-web.zip" web)

      - name: Build Linux
        if: ${{ matrix.name == 'linux' }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev
          flutter config --enable-linux-desktop
          flutter build linux --release
          mkdir -p dist
          (cd build/linux/x64/release && zip -r "../../../../dist/app-${TAG}-linux.zip" bundle)

      - name: Build Windows
        if: ${{ matrix.name == 'windows' }}
        shell: pwsh
        run: |
          flutter config --enable-windows-desktop
          flutter build windows --release
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "dist/app-$env:TAG-windows.zip"

      - name: Build macOS
        if: ${{ matrix.name == 'macos' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter config --enable-macos-desktop
          flutter build macos --release
          mkdir -p dist
          # 把 .app 压成 zip 方便发布
          ditto -c -k --sequesterRsrc --keepParent "build/macos/Build/Products/Release" "dist/app-${TAG}-macos.zip"

      - name: Build iOS (no codesign)
        if: ${{ matrix.name == 'ios' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter build ios --release --no-codesign
          mkdir -p dist
          # 这里只能拿到 Runner.app（未签名），若要 .ipa 需证书/签名流程
          (cd build/ios/iphoneos && ditto -c -k --sequesterRsrc --keepParent "Runner.app" "../../dist/app-${TAG}-ios-no-codesign.zip")

      # ---------- Upload assets to Release ----------
      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: dist/*
