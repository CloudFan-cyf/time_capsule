name: Build & Release on PR merge to main

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write # 创建 tag / release / 上传附件
  pull-requests: read

jobs:
  prepare_release:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.tag }}
      version: ${{ steps.ver.outputs.version }}
    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from pubspec.yaml and compute tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          # 读取 pubspec.yaml 的 version: 行
          version="$(grep -E '^[[:space:]]*version:[[:space:]]*' pubspec.yaml | head -n1 | sed -E 's/^[[:space:]]*version:[[:space:]]*//')"
          if [ -z "$version" ]; then
            echo "Failed to read version from pubspec.yaml" >&2
            exit 1
          fi

          # 允许 version: 1.2.3 或 1.2.3+45
          # tag 用 v${version//+/-}，避免 tag 里出现 +
          tag="v${version//+/-}"

          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Fail if tag already exists
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          tag="${{ steps.ver.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
            echo "Tag '${tag}' already exists. Please bump pubspec.yaml version/build number." >&2
            exit 1
          fi

      - name: Fail if release already exists
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${{ steps.ver.outputs.tag }}"
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release '${tag}' already exists. Please bump pubspec.yaml version/build number." >&2
            exit 1
          fi

      - name: Create Git tag
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.ver.outputs.tag }}"
          git tag "${tag}"
          git push origin "${tag}"

      - name: Create GitHub Release (notes from PR body)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          body: |
            # Release Notes
            **PR:** #${{ github.event.pull_request.number }} — ${{ github.event.pull_request.title }}

            ${{ github.event.pull_request.body }}
          draft: false
          prerelease: false

  # 2) 各平台构建：产物打包成 zip，然后上传到刚才创建的 release
  build_and_upload:
    needs: prepare_release
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: android
            os: ubuntu-latest
          - name: windows
            os: windows-latest
          - name: macos
            os: macos-latest
          - name: ios
            os: macos-latest

    runs-on: ${{ matrix.os }}
    if: ${{ github.event.pull_request.merged == true }}
    env:
      TAG: ${{ needs.prepare_release.outputs.tag }}
      VERSION: ${{ needs.prepare_release.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Flutter 安装 + cache（你也可以改成读取 FVM 版本）
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      # ---------- Build ----------
      - name: Restore Android keystore
        if: ${{ matrix.name == 'android' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android/keystore
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > android/keystore/release.jks

      - name: Write key.properties
        if: ${{ matrix.name == 'android' }}
        shell: bash
        run: |
          set -euo pipefail
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=keystore/release.jks
          EOF

      - name: Build Android (APK + AAB)
        if: ${{ matrix.name == 'android' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter build apk --release

          mkdir -p dist
          cp -f build/app/outputs/flutter-apk/app-release.apk "dist/app-${TAG}-android.apk"
      - name: Print APK signing cert (debug)
        if: ${{ matrix.name == 'android' }}
        shell: bash
        run: |
          set -euo pipefail
          APK="build/app/outputs/flutter-apk/app-release.apk"
          # 找到 apksigner（不同 runner 路径可能不同）
          APKSIGNER="$(ls "$ANDROID_SDK_ROOT/build-tools"/*/apksigner | sort -V | tail -n 1)"
          "$APKSIGNER" verify --print-certs "$APK" | sed -n '1,80p'

      - name: Build Windows
        if: ${{ matrix.name == 'windows' }}
        shell: pwsh
        run: |
          flutter config --enable-windows-desktop
          flutter build windows --release
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "dist/app-$env:TAG-windows.zip"

      - name: Build macOS
        if: ${{ matrix.name == 'macos' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter config --enable-macos-desktop
          flutter build macos --release
          mkdir -p dist
          # 把 .app 压成 zip 方便发布
          ditto -c -k --sequesterRsrc --keepParent "build/macos/Build/Products/Release" "dist/app-${TAG}-macos.zip"

      - name: Build iOS (no codesign)
        if: ${{ matrix.name == 'ios' }}
        shell: bash
        run: |
          set -euo pipefail
          flutter build ios --release --no-codesign
          mkdir -p "$GITHUB_WORKSPACE/dist"
          cd build/ios/iphoneos
          ditto -c -k --sequesterRsrc --keepParent "Runner.app" "$GITHUB_WORKSPACE/dist/app-${TAG}-ios-no-codesign.zip"
      - name: Debug dist
        if: ${{ matrix.name == 'ios' }}
        shell: bash
        run: ls -lah "$GITHUB_WORKSPACE/dist"

      # ---------- Upload assets to Release ----------
      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: dist/*
